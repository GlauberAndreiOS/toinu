generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////
// ENUMS
//////////////////////

enum TripStatus {
  REQUESTED
  ACCEPTED
  STARTED
  COMPLETED
  CANCELED
}

enum PassengerStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

enum CpfVerificationStatus {
  PENDING
  APPROVED
  REJECTED
  ERROR
}

//////////////////////
// MODELS
//////////////////////

model User {
  id                String   @id @default(uuid())

  email             String?  @unique
  phone             String?  @unique
  password          String?
  oauthProvider     String?
  oauthProviderId   String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  driver            Driver?
  passenger         Passenger?

  @@map("users")
}

model Driver {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])

  fullName          String
  birthDate         DateTime
  cpf               String   @unique @db.VarChar(14)

  phoneContact      String?
  emailContact      String?

  cnh               String   @unique
  cnhExpiration     DateTime

  address           Json?

  isApproved        Boolean  @default(false)

  vehicles          Vehicle[]
  trips             Trip[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("drivers")
}

model Vehicle {
  id                String   @id @default(uuid())
  driverId          String
  driver            Driver   @relation(fields: [driverId], references: [id])

  brand             String
  model             String
  yearOfManufacture Int
  yearOfModel       Int
  renavam           String   @unique
  licensePlate      String   @unique
  color             String

  isActive          Boolean  @default(true)

  trips             Trip[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("vehicles")
}

model Passenger {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])

  fullName          String
  cpf               String   @unique @db.VarChar(14)
  birthDate         DateTime

  phoneContact      String?

  status            PassengerStatus @default(PENDING_VERIFICATION)
  cpfVerified       Boolean         @default(false)
  cpfVerifiedAt     DateTime?

  address           Json?

  trips             Trip[]
  cpfVerifications  CpfVerification[]
  favoriteAddresses PassengerFavoriteAddress[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("passengers")
}

model PassengerFavoriteAddress {
  id          String   @id @default(uuid())
  passengerId String
  passenger   Passenger @relation(fields: [passengerId], references: [id])

  label       String   // ex: "Casa", "Trabalho"
  street      String
  number      String
  complement  String?
  neighborhood String
  city        String
  state       String
  zipCode     String

  latitude    Float?
  longitude   Float?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("passenger_favorite_addresses")
}

model CpfVerification {
  id                String   @id @default(uuid())
  passengerId       String
  passenger         Passenger @relation(fields: [passengerId], references: [id])

  cpf               String
  fullName          String
  birthDate         DateTime

  provider          String
  status            CpfVerificationStatus
  rawResponse       Json?

  createdAt         DateTime @default(now())

  @@map("cpf_verifications")
}

model Trip {
  id                String   @id @default(uuid())

  driverId          String
  driver            Driver   @relation(fields: [driverId], references: [id])

  passengerId       String
  passenger         Passenger @relation(fields: [passengerId], references: [id])

  vehicleId         String?
  vehicle           Vehicle? @relation(fields: [vehicleId], references: [id])

  origin            String
  destination       String

  status            TripStatus @default(REQUESTED)

  startedAt         DateTime?
  finishedAt        DateTime?

  price             Decimal?
  distanceKm        Decimal?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("trips")
}
